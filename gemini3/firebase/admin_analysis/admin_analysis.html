<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å­¦ç¿’ãƒ­ã‚°é›†è¨ˆãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Firebase Configï¼ˆä»–ã¨å…±é€šï¼‰ ---
        const firebaseConfig = {
            apiKey: "AIzaSyAOJnHuUqjc8caecnNu_pkul2ORvzWmox0",
            authDomain: "start01-20260120a-76f80.firebaseapp.com",
            projectId: "start01-20260120a-76f80",
            storageBucket: "start01-20260120a-76f80.firebasestorage.app",
            messagingSenderId: "213284691100",
            appId: "1:213284691100:web:046aa5f86e4cb1a2562159"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function fetchAndSummarize(colName) {
            const status = document.getElementById("status");
            status.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...";
            
            try {
                const q = query(collection(db, colName), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                const rawLogs = [];
                
                querySnapshot.forEach((doc) => {
                    const d = doc.data();
                    rawLogs.push({
                        time: d.timestamp?.toDate().toLocaleString() || "N/A",
                        student_id: d.student_id,
                        student_name: d.student_name,
                        problem: d.problem,
                        miss: d.miss_count || 0,
                        duration: d.duration || 0
                    });
                });

                // ç”Ÿå¾’ã”ã¨ã«é›†è¨ˆ
                const summaryMap = {};
                rawLogs.forEach(log => {
                    if (!summaryMap[log.student_id]) {
                        summaryMap[log.student_id] = {
                            name: log.student_name,
                            correctCount: 0,
                            totalMiss: 0,
                            totalDuration: 0,
                            firstTime: log.time,
                            lastTime: log.time
                        };
                    }
                    const s = summaryMap[log.student_id];
                    s.correctCount++;
                    s.totalMiss += log.miss;
                    s.totalDuration += log.duration;
                    s.lastTime = log.time; // é™é †ã§å–ã£ã¦ã„ã‚‹ã®ã§ã€æœ€åˆã«å‡ºã‚‹ã®ãŒæœ€æ–°
                });

                renderTable(summaryMap, colName);
                status.textContent = `å®Œäº†: ${rawLogs.length}ä»¶ã®ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`;
            } catch (e) {
                status.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message;
            }
        }

        function renderTable(summaryMap, colName) {
            const container = document.getElementById("table-container");
            let html = `<h2 class="text-xl font-bold mb-4">${colName} ã®é›†è¨ˆçµæœ</h2>
                        <table class="w-full text-left border-collapse border border-slate-300 mb-8">
                        <thead><tr class="bg-slate-100">
                            <th class="border p-2">ç”Ÿå¾’ç•ªå·</th><th class="border p-2">åå‰</th>
                            <th class="border p-2">æ­£è§£æ•°</th><th class="border p-2">ãƒŸã‚¹åˆè¨ˆ</th>
                            <th class="border p-2">ç·æ™‚é–“(ç§’)</th><th class="border p-2">æœ€æ–°æ—¥æ™‚</th>
                        </tr></thead><tbody>`;

            const rows = [];
            for (const id in summaryMap) {
                const s = summaryMap[id];
                html += `<tr>
                    <td class="border p-2">${id}</td><td class="border p-2">${s.name}</td>
                    <td class="border p-2">${s.correctCount}</td><td class="border p-2">${s.totalMiss}</td>
                    <td class="border p-2">${s.totalDuration.toFixed(1)}</td><td class="border p-2">${s.firstTime}</td>
                </tr>`;
                rows.push([id, s.name, s.correctCount, s.totalMiss, s.totalDuration.toFixed(1), s.firstTime]);
            }
            html += `</tbody></table>`;
            
            const csvBtn = document.createElement("button");
            csvBtn.textContent = "CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
            csvBtn.className = "bg-green-600 text-white px-4 py-2 rounded mb-10";
            csvBtn.onclick = () => downloadCSV(rows, colName);
            
            container.innerHTML = html;
            container.prepend(csvBtn);
        }

        function downloadCSV(rows, colName) {
            const headers = ["ç”Ÿå¾’ç•ªå·", "åå‰", "æ­£è§£æ•°", "ãƒŸã‚¹åˆè¨ˆ", "ç·æ™‚é–“(ç§’)", "æœ€æ–°æ—¥æ™‚"];
            const content = [headers, ...rows].map(r => r.join(",")).join("\n");
            const blob = new Blob(["\ufeff" + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${colName}_summary_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        window.fetchData = fetchAndSummarize;
    </script>
</head>
<body class="p-8 bg-slate-50">
    <h1 class="text-3xl font-bold mb-6">ğŸ“Š Firebaseãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒ‘ãƒãƒ«</h1>
    <div class="flex gap-4 mb-6">
        <button onclick="fetchData('logs_1nen')" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-blue-700">1å¹´ç”Ÿã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
        <button onclick="fetchData('logs_2nen')" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-indigo-700">2å¹´ç”Ÿã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
    </div>
    <div id="status" class="text-slate-600 mb-4 font-mono"></div>
    <div id="table-container" class="bg-white p-4 rounded-lg shadow overflow-auto"></div>
</body>
</html>